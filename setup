echo "SETTING CURRENT USER"
export CURRENT_USER=$(id -u):$(id -g)

if [[ $SHELL == *"bash"* ]]; then
	read -p $'Enter your CUIC Devops Server username: \n> ' DEV_SERVER_USERNAME
	export DEV_SERVER_USERNAME

	read -sp $'Enter your CUIC Devops Server password: \n> ' DEV_SERVER_PASSWORD
	export DEV_SERVER_PASSWORD
else
	echo $'Enter your CUIC Devops Server username:'
	read DEV_SERVER_USERNAME
	export DEV_SERVER_USERNAME

	echo $'Enter your CUIC Devops Server password:'
	stty -echo
	read DEV_SERVER_PASSWORD
	export DEV_SERVER_PASSWORD
	stty echo
fi

export DEV_NPM_TOKEN=`echo -n "${DEV_SERVER_USERNAME}:${DEV_SERVER_PASSWORD}" | openssl base64`

export HTTP_PROXY=devops.cuic.mitre.org

# Docker login
echo $DEV_SERVER_PASSWORD | docker login devops.cuic.mitre.org --username ${DEV_SERVER_USERNAME} --password-stdin

# Poetry credentials
if ! command -v poetry &> /dev/null
then
    echo "Poetry not installed. Skipping..."
    return
fi
poetry config http-basic.cuic-devops-registry ${DEV_SERVER_USERNAME} ${DEV_SERVER_PASSWORD}
if [ -f "/etc/ssl/certs/ca-certificates.crt" ]; then
    CERT_PATH="/etc/ssl/certs/ca-certificates.crt"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    OPENSSL_DIR=$(openssl version -d | cut -d'"' -f2)
    CERT_PATH="${OPENSSL_DIR}/cert.pem"
fi
poetry config certificates.cuic-devops-registry.cert $CERT_PATH
poetry config repositories.cuic-devops-publish https://devops.cuic.mitre.org/nexus/repository/python-hosted/
poetry config http-basic.cuic-devops-publish ${DEV_SERVER_USERNAME} ${DEV_SERVER_PASSWORD}

poetry config certificates.cuic-devops-publish.cert $CERT_PATH
poetry config certificates.cuic-devops-publish.cert /etc/ssl/certs/ca-certificates.crt

if [[ -n "${SSL_CERT_FILE}" ]]; then
    poetry config certificates.cuic-devops-registry.cert ${SSL_CERT_FILE}
    poetry config certificates.cuic-devops-publish.cert ${SSL_CERT_FILE}
fi